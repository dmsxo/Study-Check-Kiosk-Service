# 1. 로그 포맷 (기존 유지)
log_format api_log_format '$remote_addr - $remote_user [$time_local] "$request" '
                          '$status $body_bytes_sent "$http_referer" '
                          '"$http_user_agent" ${request_time}s';

# 2. 통합 zrok 서버 블록 (단일 관문)
server {
    listen 80;
    # zrok에서 설정한 고정 주소 (ZROK_UNIQUE_NAME)를 적어주세요.
    server_name my-project.share.zrok.io;

    client_max_body_size 0; # MinIO 업로드를 위해 제한 해제
    access_log /var/log/nginx/zrok_access.log api_log_format;

    # --- 공통 프록시 설정 ---
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto https; # zrok이 HTTPS이므로 강제 설정
    proxy_http_version 1.1;
    proxy_set_header Upgrade $http_upgrade;
    proxy_set_header Connection "upgrade";

    # [A] API Server (기본 경로)
    location / {
        proxy_pass http://api-server:3000;
        add_header X-Frame-Options "SAMEORIGIN";
    }

    # [B] Portainer ( /ops/ 경로 )
    location /ops/ {
        # /ops/를 떼고 전달하기 위해 뒤에 /를 붙입니다.
        proxy_pass http://portainer:9000/;
    }

    # [C] MinIO Console ( /s3-console/ 경로 )
    location /s3-console/ {
        proxy_pass http://minio-s3:9001/;
    }

    # [D] MinIO API ( /s3/ 경로 )
    location /s3/ {
        proxy_pass http://minio-s3:9000/;
        chunked_transfer_encoding off;
    }
}